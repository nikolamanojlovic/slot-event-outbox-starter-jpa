databaseChangeLog:

  - property:
      name: schemaName
      value: public

  - changeSet:
      id: 001-create-event-outbox-table
      author: system
      changes:
        - sql:
            sql: |
              CREATE TABLE ${schemaName}.event_outbox (
                id UUID PRIMARY KEY,
                event_type VARCHAR(255) NOT NULL,
                payload CLOB NOT NULL,
                occurred_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                published BOOLEAN NOT NULL DEFAULT FALSE,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                retry_count INT NOT NULL DEFAULT 0,
                error_message CLOB
              );
      rollback:
        - sql:
            sql: DROP TABLE IF EXISTS ${schemaName}.event_outbox;

  # 002: Add index on unpublished events
  - changeSet:
      id: 002-add-unpublished-index
      author: system
      changes:
        - sql:
            sql: |
              CREATE INDEX idx_event_outbox_unpublished
              ON ${schemaName}.event_outbox(occurred_at, id)
              WHERE published = false;
      rollback:
        - sql:
            sql: DROP INDEX IF EXISTS idx_event_outbox_unpublished;

  # 003: Create event_outbox_cursor table
  - changeSet:
      id: 003-create-event-outbox-cursor-table
      author: system
      changes:
        - sql:
            sql: |
              CREATE TABLE ${schemaName}.event_outbox_cursor (
                processor_name VARCHAR(100) PRIMARY KEY,
                cursor TIMESTAMP NOT NULL,
                tie_breaker UUID NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
              );
      rollback:
        - sql:
            sql: DROP TABLE IF EXISTS ${schemaName}.event_outbox_cursor;
