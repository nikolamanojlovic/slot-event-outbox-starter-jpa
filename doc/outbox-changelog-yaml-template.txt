databaseChangeLog:
  - changeSet:
      id: 001-create-event-outbox-table
      author: system
      changes:
        - sql:
            sql: |
              CREATE TABLE ${schemaName}.event_outbox (
                id UUID PRIMARY KEY,
                event_type VARCHAR(255) NOT NULL,
                payload JSONB NOT NULL,
                occurred_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                published BOOLEAN NOT NULL DEFAULT FALSE,
                created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                retry_count INT NOT NULL DEFAULT 0,
                error_message TEXT
              );
      rollback:
        - sql:
            sql: DROP TABLE IF EXISTS ${schemaName}.event_outbox;

  - changeSet:
      id: 002-add-unpublished-index
      author: system
      changes:
        - sql:
            sql: |
              CREATE INDEX idx_event_outbox_unpublished
              ON ${schemaName}.event_outbox(occurred_at, id)
              WHERE published = false;
      rollback:
        - sql:
            sql: DROP INDEX IF EXISTS idx_event_outbox_unpublished;

  - changeSet:
      id: 003-create-event-outbox-cursor-table
      author: system
      changes:
        - sql:
            sql: |
              CREATE TABLE ${schemaName}.event_outbox_cursor (
                processor_name VARCHAR(100) PRIMARY KEY,
                cursor TIMESTAMPTZ NOT NULL,
                tie_breaker UUID NOT NULL,
                created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
              );
      rollback:
        - sql:
            sql: DROP TABLE IF EXISTS ${schemaName}.event_outbox_cursor;
